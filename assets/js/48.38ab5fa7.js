(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{360:function(s,t,a){"use strict";a.r(t);var e=a(2),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"零-前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#零-前言"}},[s._v("#")]),s._v(" 零.前言")]),s._v(" "),a("p",[s._v("因业务需要, 需要将我们的系统与企业微信进行对接, 特此记录一下其中的点")]),s._v(" "),a("ul",[a("li",[s._v("开发工具: 因为工具用的是企业微信, 不能设置 debugger, "),a("strong",[s._v("否则企业微信卡死")])]),s._v(" "),a("li",[s._v("企业微信的debug模式无法进行移动端适配")])]),s._v(" "),a("h2",{attrs:{id:"一-概念理清"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-概念理清"}},[s._v("#")]),s._v(" 一.概念理清")]),s._v(" "),a("p",[s._v("官方的开发需知一定要认真读, 理清基本的概念:")]),s._v(" "),a("p",[s._v("1.企业内部应用和第三方应用")]),s._v(" "),a("p",[s._v("2.上线和上架")]),s._v(" "),a("p",[s._v("**一定要仔细读文档, 一定要仔细读文档, 一定要仔细读文档, **")]),s._v(" "),a("h2",{attrs:{id:"二-快速开始"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-快速开始"}},[s._v("#")]),s._v(" 二.快速开始")]),s._v(" "),a("p",[s._v("作为一个前端, 如何准备哪些东西, 方便快速开始自己的项目呢?")]),s._v(" "),a("p",[s._v("除了看官方文档的"),a("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90142/90595",target:"_blank",rel:"noopener noreferrer"}},[s._v("快速入门"),a("OutboundLink")],1),s._v(", 这里总结了下流程:")]),s._v(" "),a("h3",{attrs:{id:"_1-创建一个企业微信账户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建一个企业微信账户"}},[s._v("#")]),s._v(" 1.创建一个企业微信账户")]),s._v(" "),a("p",[s._v("你所在企业作为第三方应用服务商开发应用, 开发完成需要另外一个企业作为使用方使用你的应用, 为了方便测试, 最好的方法是,以你的账号申请一个企业, 用来安装应用进行测试")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/1171760127A641038EB53188B17C9AE2/59631",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"_2-创建应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建应用"}},[s._v("#")]),s._v(" 2.创建应用")]),s._v(" "),a("p",[s._v("需要你所在企业的企业管理员扫码登录"),a("a",{attrs:{href:"https://open.work.weixin.qq.com/wwopen/developer#/index",target:"_blank",rel:"noopener noreferrer"}},[s._v("企业微信服务商后台"),a("OutboundLink")],1),s._v(", 在应用管理那里选择-> 创建项目, 之后在应用主页设置各种配置信息")]),s._v(" "),a("h3",{attrs:{id:"_3-可信域名与内网穿透"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-可信域名与内网穿透"}},[s._v("#")]),s._v(" 3.可信域名与内网穿透")]),s._v(" "),a("p",[s._v("由于企业微信("),a("strong",[s._v("微信,微信公众号,小程序webview可信域名授权同理")]),s._v(")的第三方 H5 应用需要配置可信域名, 而本地开发地址显然是无法通过企业微信的域名校验的，解决的方法目前有两种：")]),s._v(" "),a("h4",{attrs:{id:"方法一-修改本地的host和使用nginx代理-推荐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法一-修改本地的host和使用nginx代理-推荐"}},[s._v("#")]),s._v(" 方法一. 修改本地的host和使用nginx代理(推荐)")]),s._v(" "),a("p",[s._v("假设本地跑了一个服务，访问地址为: localhost:8080")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("host文件修改")])])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/hosts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("不会vi可以使用熟悉的编辑器,  如vscode打开(需要执行ctrl+shift +p => install code command in Path)")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" code /etc/hosts\t\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("编辑文件,添加下面一行并保存")]),s._v(" "),a("blockquote",[a("p",[s._v("127.0.0.1   www.example.com(自行替换)")])]),s._v(" "),a("p",[s._v("尝试访问: "),a("code",[s._v("http://www.example.com:8080")]),s._v("，"),a("strong",[s._v("(注意不是https)")]),s._v(", 应该能看到页面了,")]),s._v(" "),a("p",[s._v("如果不成，ping一下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" www.example.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.051")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.158")]),s._v(" ms\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("strong",[s._v("nginx代理")])])]),s._v(" "),a("p",[s._v("但是我们在填写主页地址的时候是只能填写不带端口的地址的，因此需要使用nginx来做反向代理，实现"),a("code",[s._v("https://www.example.com")]),s._v("的访问")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.nginx.com/resources/wiki/start/topics/tutorials/install/",target:"_blank",rel:"noopener noreferrer"}},[s._v("nginx安装"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.liaoxuefeng.com/article/990311924891552",target:"_blank",rel:"noopener noreferrer"}},[s._v("ssl证书安装"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("ps1:  遇见无权限的时候执行")]),s._v(" "),a("blockquote",[a("p",[s._v("chmod +x ./gencert.sh")])]),s._v(" "),a("p",[s._v("ps2: 按照作者的流程搞完之后，多了以下几个文件")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/031896BFEAC04A3AB292227F03A0CAE3/59611",alt:""}})]),s._v(" "),a("p",[s._v("nginx.conf文件, 位于/usr/local/nginx/conf, /etc/nginx, 或 /usr/local/etc/nginx. 可直接用")]),s._v(" "),a("p",[s._v("可以使用下列命令查看conf文件位置")]),s._v(" "),a("blockquote",[a("p",[s._v("nginx -t")])]),s._v(" "),a("div",{staticClass:"language-nginxconf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("worker_processes  1;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    # HTTPS server\n    server {\n       listen       443 ssl;\n       server_name  www.example.com;\n\n       ssl_certificate      /usr/local/etc/nginx/ssl/www.example.com.crt;\n       ssl_certificate_key  /usr/local/etc/nginx/ssl/www.example.com.key;\n\n       ssl_session_cache    shared:SSL:1m;\n       ssl_session_timeout  5m;\n\n       ssl_ciphers  HIGH:!aNULL:!MD5;\n       ssl_prefer_server_ciphers  on;\n\n       location / {\n           root   html;\n           index  index.html index.htm;\n           proxy_pass          http://localhost:8080;\n       }\n    }\n    include servers/*;\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("h4",{attrs:{id:"方法二-使用花生壳等内网穿透工具-后期比较麻烦-不推荐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法二-使用花生壳等内网穿透工具-后期比较麻烦-不推荐"}},[s._v("#")]),s._v(" 方法二. 使用花生壳等内网穿透工具(后期比较麻烦，不推荐)")]),s._v(" "),a("p",[s._v("原理感兴趣可以自行搜索,简单而言就是可以把你的"),a("code",[s._v("本地localhost的服务映射到公网的地址")]),s._v(", 以花生壳为例,会自动分配一个域名给你, "),a("code",[s._v("xxxxxxx.oicp.vip")]),s._v(", 配置好穿透之后, 将对应的域名填上去就好了.")]),s._v(" "),a("p",[s._v("不推荐的原因:")]),s._v(" "),a("ol",[a("li",[s._v("域名需要实名验证，而且每过两天就会让你验证一次，比较麻烦")]),s._v(" "),a("li",[s._v("付费，而且有流量限制")]),s._v(" "),a("li",[s._v("花生壳的这种域名在微信是打不开的，所以如果你用了"),a("code",[s._v("家校通")]),s._v("的话，家长从微信打开会有问题")])]),s._v(" "),a("h2",{attrs:{id:"三-设置各种回调"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-设置各种回调"}},[s._v("#")]),s._v(" 三.设置各种回调")]),s._v(" "),a("p",[s._v("这步需要后端人员的配合, 只有这步走完之后才能够进行测试")]),s._v(" "),a("h2",{attrs:{id:"四-本地开发与安装调试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-本地开发与安装调试"}},[s._v("#")]),s._v(" 四.本地开发与安装调试")]),s._v(" "),a("h3",{attrs:{id:"_1-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装"}},[s._v("#")]),s._v(" 1.安装")]),s._v(" "),a("p",[s._v("当前端项目初始化完成, 后端回调配置 ok 之后, 就可以尝试安装了, 具体看"),a("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90142/90595",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("安装完成之后使用你的测试企业, 进入应用管理, 点开相关的应用, 进行配置, 比如可见范围设置所有开发人员可见")]),s._v(" "),a("h3",{attrs:{id:"_2-调试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-调试"}},[s._v("#")]),s._v(" 2.调试")]),s._v(" "),a("p",[a("strong",[s._v("方法一：")]),s._v("\n打开微信开发者工具，选择公众号模式, 但是"),a("a",{attrs:{href:"https://developers.weixin.qq.com/community/develop/doc/000eca560902209b31b78c72b5b400",target:"_blank",rel:"noopener noreferrer"}},[s._v("不一定成功"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("strong",[s._v("方法二：")])]),s._v(" "),a("p",[s._v("企业微信内部可以启用"),a("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90000/90139/90315#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E8%AF%95",target:"_blank",rel:"noopener noreferrer"}},[s._v("开发者模式"),a("OutboundLink")],1)]),s._v(" "),a("ul",[a("li",[s._v("mac: ctrl + command + shift + D")])]),s._v(" "),a("p",[s._v("然后右键点击-> 审查元素即可")]),s._v(" "),a("p",[s._v("但是有几点坑的地方:")]),s._v(" "),a("ol",[a("li",[s._v("别加 debugger, 会直接卡死")]),s._v(" "),a("li",[s._v("无法使用移动端模拟器, 如 iphone6")])]),s._v(" "),a("p",[s._v("ps: 微信小程序开发工具目前已经有"),a("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90000/90139/90315",target:"_blank",rel:"noopener noreferrer"}},[s._v("企业微信小程序的支持"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"五-接入授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五-接入授权"}},[s._v("#")]),s._v(" 五.接入授权")]),s._v(" "),a("p",[s._v("因为我们是 H5 应用, 需要走网页授权拿到用户的身份信息, 参考"),a("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90143/91118",target:"_blank",rel:"noopener noreferrer"}},[s._v("网页授权登录"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("授权需要放置校验文件，项目使用的是uniapp, 在 public 文件夹放置校验文件, 只要你能够通过"),a("code",[s._v("www.test.com/MEkcNmXU1TXwd0eZ.txt")]),s._v("访问到该文件就行, 线上部署,每次 build 项目的时候, 也需要添加相应的校验文件")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"npm run build:h5 && npm run verify"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"verify"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"echo 'MEkcNmXU1TXwd0eZ' > dist/build/h5/WW_verify_MEkcNmXU1TXwd0eZ.txt\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"六-接入-sdk"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六-接入-sdk"}},[s._v("#")]),s._v(" 六.接入 sdk")]),s._v(" "),a("p",[s._v("签名会比较麻烦, 主要是后端处理")]),s._v(" "),a("h3",{attrs:{id:"引入sdk"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#引入sdk"}},[s._v("#")]),s._v(" 引入sdk")]),s._v(" "),a("p",[s._v("两个sdk, 第一个用户普通接口,比如扫码, 需要config配置, 一个用于企业微信特定的API, 比如获取企业微信联系人")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"><\/script>\n<script src="https://open.work.weixin.qq.com/wwopen/js/jwxwork-1.0.0.js"><\/script>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("引入之后是没有"),a("code",[s._v("wx")]),s._v("对象的, 只有"),a("code",[s._v("jweixin对象")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const wx = window.jWeixin\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("使用模块引入")]),s._v(" "),a("h3",{attrs:{id:"_63002-错误码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_63002-错误码"}},[s._v("#")]),s._v(" 63002 错误码")]),s._v(" "),a("ol",[a("li",[s._v("确认timestamp是s, 也就是10位")]),s._v(" "),a("li",[s._v("确认后端要对url进行decode")]),s._v(" "),a("li",[s._v("agentConifg签名用的noncestr和timestamp必须与wx.config中的nonceStr和timestamp相同。")])]),s._v(" "),a("h2",{attrs:{id:"七-总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七-总结"}},[s._v("#")]),s._v(" 七.总结")]),s._v(" "),a("p",[s._v("走完上面几步, 基本的开发步骤就算走完了, 接下来是真正的需求实现, 期间也遇到不少坑, 想到再补吧")]),s._v(" "),a("h2",{attrs:{id:"八-踩坑汇总"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#八-踩坑汇总"}},[s._v("#")]),s._v(" 八.踩坑汇总")]),s._v(" "),a("h3",{attrs:{id:"_1-多平台接入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-多平台接入"}},[s._v("#")]),s._v(" 1. 多平台接入")]),s._v(" "),a("p",[s._v("因为我们的 H5 应用此前对接了很多平台，而作为企业微信第三方 H5 应用使用的，接入的是企业微信的家校通，所以就要考虑以下情况")]),s._v(" "),a("ul",[a("li",[s._v("普通H5登录, 走普通登录页面")]),s._v(" "),a("li",[s._v("家长从微信打开普通的 H5, 需要走的微信的授权")]),s._v(" "),a("li",[s._v("(企业微信通讯录同步的)家长从微信打开家校通入口，找到我的学校，在我的学校里面打开 H5, 需要走的是企业微信的授权")]),s._v(" "),a("li",[s._v("企业微信的推送通知, 需要走的是企业微信授权")]),s._v(" "),a("li",[s._v("(企业微信通讯录同步的)老师从企业微信打开，需要走的是企业微信的授权")])]),s._v(" "),a("p",[s._v("问题来了: 无法通过判断 userAgent 的形式判断是需要走微信的授权,还是企业微信授权, 因此需要传递某些特定的参数, 如"),a("code",[s._v("system=work-wechat")])]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("navigator"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("userAgent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("toLowerCase")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token regex"}},[a("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("MicroMessenger")]),a("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token regex-flags"}},[s._v("i")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'micromessenger'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" system "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'work-wechat'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      uni"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setStorageSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'platform'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'wechat'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 微信平台")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_2-企业微信-40029-状态码报错-不合法的-oauth-code"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-企业微信-40029-状态码报错-不合法的-oauth-code"}},[s._v("#")]),s._v(" 2. 企业微信 40029 状态码报错: 不合法的 oauth_code")]),s._v(" "),a("p",[s._v("原因一: 微信出现两次重定向, 而两次携带的都是相同的 code, 第一次使用之后 code 就失效了\n解决: 添加"),a("code",[s._v("connect_redirect=1")]),s._v("字段到链接中")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" redirectUrl "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("https://open.weixin.qq.com/connect/oauth2/authorize?appid=wwa8575b53d140807a&redirect_uri=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("${")]),s._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("VUE_APP_WORKWECHAT_REDIRECT_ENDPOINT")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("%2Fpages%2Flogin%2Fwork-wechat&response_type=code&scope=snsapi_userinfo&state=normal&connect_redirect=1#wechat_redirect")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("location"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("href "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redirectUrl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("原因二: 构造链接中的 appid 没有填写正确")]),s._v(" "),a("p",[s._v("检查构造的 redirectUrl 中的 appid 和 secret 是否填写正确，由于我们的应用有两个，为教师端和家长端，测的时候匆忙，错把家长端的 appid 当成了学校端的")]),s._v(" "),a("h2",{attrs:{id:"附录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#附录"}},[s._v("#")]),s._v(" 附录")])])}),[],!1,null,null,null);t.default=n.exports}}]);